# CASL II アセンブラ & COMET II シミュレータ Javascript版 (casl2/comet2 js)

## 概要

casl2/comet2 jsは情報処理技術者試験において定義される仮想計算機COMET IIのシミュレータとそのアセンブラCASL IIをJavascriptで実装したものです。Javascriptが動く一般的なWebブラウザ環境なら、難なく動かすことができます。

casl2/comet2 jsは、GPLに基づくフリーソフトウェアとして配布しています。

## 仕様

実装されている基本機能

* COMET IIの命令セット一式、CASL IIでのマクロ一式
* レジスタのモニタリング
* メモリのダンプ
* ステップ実行、連続実行
* ブレークポイントの設定
* ディスアセンブル
* メモリへの直接アクセス
* 独自の拡張に基づく実装

  * 簡単のため，MULA (算術乗算), MULL (論理乗算), DIVA (算術除算), DIVL (論理除算)を実装しています．利用方法はADDA, ADDL等とほぼ同じです．
  * DIVA, DIVLについては，0除算を行おうとするとZFとOFが同時に立って，計算は行われません．端末に警告が表示されますが，実行自体は止まらずに先に進みます．
  * ラベルのスコープ (casl2)
  ラベルのスコープについてはCASL IIの仕様には特に記述がありません．本実装では，プログラム内(STARTからENDまで)に独自の名前空間を与えることで，ラベルを局所変数のように扱えます．その一方で、大域変数に相当するものはありません．また，CALL命令だけは，スコープ外の別プログラムのラベルを参照できます．

* サイレントモード (comet2)
  comet2の実行時に-Qオプションを付けることで、OUT命令の出力以外を一切表示させないようにできます。

## 利用方法

index.htmlをブラウザで開いてください．

### CASL II アセンブラの基本的な使い方

casl2アセンブラを使うには、casl2のソースコードを左上のテキストボックスにペーストします．
その後，「Assemble」ボタンを押すと，アセンブルが実施されます．
文法エラーなどはこの時点で検出されます。例えば、

```
2: Illegal instruction "LEA"
2: Undefined symbol "TEST"
```
のように左下のボックスに何らかのメッセージが出て終了した場合は、表示されている行番号にエラーがあることを示しています。エディタで修正して再度アセンブルしてください。

* IN/OUTマクロ命令の実装

CASL2ではIN/OUTというマクロ命令が定義されています．本実装では，IN/OUTを次のように展開します．

INの場合
```
         IN      INBUF,INLEN
...
INLEN    DS      1
INBUF    DS      20
```
```
    PUSH 0,GR1
    PUSH 0,GR2
    LAD  GR1,INBUF
    LAD  GR2,INLEN
    SVC  #fff0
    POP  GR2
    POP  GR1
```

OUTの場合
```
          OUT     OUTBUF,OUTLEN
...
OUTLEN    DC      13
OUTBUF    DC      'Hello, CASL2.'
```
```
    PUSH 0,GR1
    PUSH 0,GR2
    LAD  GR1,OUTBUF
    LAD  GR2,OUTLEN
    SVC  #fff2
    POP  GR2
    POP  GR1
```
別に実装はどうでも良いのですが，SVCが余っていたので，それを使うコードにしています．
どちらも7命令に膨れ上がりますので，気をつけてください．

同様に，RPUSH, RPOPもマクロですので，7つのPUSH, POPに展開されます．

### 詳細なアセンブル結果

Javascript版では，詳細なアセンブル結果が常に表示されます．
次のようなプログラムを作ります．
```
TEST    START
        LAD     GR1,#000f
        LD      GR2,LAB1
        ADDA    GR1,GR2
        RET
LAB1    DC      245
        END
```
これをアセンブルした結果，ログウィンドウに次のような出力がなされます．

```
CASL LISTING
   2 0000 1210		LAD	GR1,#000f
   2      000f
   3 0002 1020		LD	GR2,LAB1
   3      0006
   4 0004 2412		ADDA	GR1,GR2
   5 0005 8100		RET	
   6 0006 00f5	LAB1	DC	245

DEFINED SYMBOLS
1:	0000	TEST
6:	0006	LAB1 (TEST)
```

上側のリストは左から、「行番号」「機械語の格納番地」「機械 語命令」「ラベル」「対応するCASL II命令」を表します。例えば、この例では2行目に書かれた命令`LAD GR1,#000f`は`1210 000f`という2語の機械語命令に変換され、`#0000`番地に格納されたことが分かります。

下側のリストはプログラム中で定義されたラベルの一覧です。どのラベル が何番地に対応するのかを表示しています。6行目で定義されたラベル`LAB1`は`0006`番地を示すことがわかります。

ここで出力される詳細情報はcomet2でブレークポイントを設定する際に必要となります。ややこしいデバッグをするときなどに威力を発揮しますので是非覚えて下さい。

## COMET II シミュレータの使い方

### 基本的な使い方

CASL IIアセンブラが正常に実行されると，右側のターミナル内でCOMET IIシミュレータが初期化され，実行準備が整います．

```
This is COMET II, version x.xx KIT version (....).
Copyright (c) 2001-2022, Osamu Mizuno.

PR  #0000 [ LAD      GR1, #000f      ]
SP  #ff00(  -256)  FR  000  (     0)
GR0 #0000(     0)  GR1 #0000(     0)  GR2 #0000(     0)  GR3 #0000(     0)
GR4 #0000(     0)  GR5 #0000(     0)  GR6 #0000(     0)  GR7 #0000(     0)
comet2>
```

画面に表示されているのは各レジスタの初期値です。1行目には現在のプログラムレジスタ(`PR`)の値 (`#0000`) とこれから実行すべき機械語命令 (`#0000`番地の中身) が表示されています。そして、ユーザの入力を待つため、`comet2>`というプロンプトが出て停止します。

* ステップ実行 s(tep)

1命令だけ実行させるにはstep（または s）という命令を使います。

* 実行 r(un)

全命令を一気に実行させるにはrun（または r）という命令を使います。ただし、無限ループが存在するプログラムを run で実行させると固まったように見えます。この場合は、Ctrl-c を入力してcomet2の実行を強制終了させて下さい。

* メモリダンプ du(mp)

計算機COMET IIの主記憶内を見るにはdump（または du）という命令を使います。何に使うのか？ST命令の実行が正しく行われているかを見るのが第1の目的だと思ってもらって結構です。

### 高度な使い方

* ブレークポイント設定 b(reak)

COMET IIシミュレータには機械語プログラムの実行中、あらかじめ設定された番地まで実行が進むと一時的に実行を停止する機能があります。このとき、あらかじめ設定された番地のことをブレークポイントと呼びます。

ブレークポイントの設定にはbreak (または b)という命令を使います。

この機能は特に長いプログラムをデバッグするときに有効です。1000行もあるプログラムの終わりの100行に存在するであろうバグを発見するためにstepを何百回も繰り返してその場所まで到達するのはどう考えても非効率です。そこでデバッグしたい部分の入り口の番地をブレークポイントにする ことで、そこまでの実行は run で行うことが出来ます。

この機能を有効に使うためには、casl2アセンブラの -a オプションで生成される詳細なアセンブル結果が必須です。（慣れた人なら dump の結果だけでも適切なブレークポイントを判別できるかも知れません。）

### CASL II アセンブラ: リファレンス

* [Assemble]ボタン

入力したCASLののソースコードをアセンブルします．
アセンブルに成功すると，右側のCOMET2こ機械語がロードされ，実行準備が整います．

### COMET II シミュレータ: コマンドリファレンス

* 実行 r (run)

  Start execution of program.

  プログラムの実行を開始します。設定されたブレークポイントが存在すると、実行を一旦停止し、コマンド待ち状態に戻ります。ブレークポイントが無い場合は、プログラムの最後まで実行を続けるため、必要に応じて Ctrl-C でcomet2シミュレータの動作自体を停止する必要があります。

* ステップ実行 s (step)

  Step execution. Argument N means do this N times.

  ステップ実行を行います。引数を指定しないと、1命令分だけ前に進みます。
```
comet2> s 20
```
  のように引数を指定すると、指定した数だけ命令を実行して停止します。

* ブレークポイント設定 b (break)

  Set a breakpoint at specified address.

  ブレークポイントの設定を行います。引数は必須で、
```
comet> b #0010
```
  のように指定します。引数はプログラムを停止すべきアドレスを表します。アドレスには10進、16進の表記を使うことができますが、casl2プログラムで指定したラベルを用いることはできません。任意の場所で実行を止めるためには、caslで出力される詳細なアセンブル結果を利用することが必要です。

* ブレークポイント情報表示 i (info)

  Print information on breakpoints.

* ブレークポイント削除 d (delete)

  Delete some breakpoints.

  ブレークポイントを削除します。引数を指定しない場合はすべてのブレークポイントを削除するかの確認がされます。`info` コマンドで表示されるブレークポイント番号を引数をして指定することで、任意のブレークポイントを削除できます。

* レジスタ表示 p (print)

  Print status of PC/FR/SP/GR0..GR7 registers.

  レジスタの状態を表示します。`step` の後には必ず実行されます。

* メモリダンプ du (dump)

  Dump 128 words of memory image from specified address.

  128語分のメモリイメージを表示します。引数を与えない場合は現在のPCのアドレスから表示されます。引数を与えることで、任意のアドレスからのダンプを行います。

* スタックダンプ st (stack)

  Dump 128 words of stack image.

  スタックの内容を128ワード分表示します。

* ジャンプ j (jump)

  Continue program at specifed address.

  引数は必須です。PCを引数で指定したアドレスに強制的に指定し、その番地からプログラムを実行させます。

* メモリ書き込み m (memory)

  Change the memory at ADDRESS to VALUE.

  引数は2つが必須です。

```
comet2> m ADDRESS VALUE
```
`ADDRESS` に番地を、`VALUE` には値を指定し、`ADDRESS`で示した番地に`VALUE`を強制的に書き込みます。

* 逆アセンブル di (disasm)

  Disassemble 32 words from specified address.

  引数で指定した番地から32ワード分を逆アセンブルします。引数を省略すると、現在の`PC`が示す番地からになります。

* ヘルプ表示 h (help)

  Print list of commands.
