# CASL II アセンブラ & COMET II シミュレータ Javascript版 (casl2/comet2 js)

## 概要

casl2/comet2 js は情報処理技術者試験において定義される仮想計算機 COMET II のシミュレータとそのアセンブラ CASL II を Javascript で実装したものです．Javascript が動く一般的な Web ブラウザ環境なら，難なく動かすことができます．

casl2/comet2 js は，GPL に基づくフリーソフトウェアとして配布しています．

## 仕様

実装されている基本機能

* COMET II の命令セット一式，CASL II でのマクロ一式
* レジスタのモニタリング
* メモリのダンプ
* ステップ実行，連続実行
* ブレークポイントの設定
* ディスアセンブル
* メモリへの直接アクセス
* 独自の拡張に基づく実装

  * 簡単のため，`MULA` (算術乗算), `MULL` (論理乗算), `DIVA` (算術除算), `DIVL` (論理除算)を実装しています．利用方法は `ADDA`, `ADDL` 等とほぼ同じです．
  * `DIVA`, `DIVL` については，0 除算を行おうとすると `ZF` と `OF` が同時に立って，計算は行われません．端末に警告が表示されますが，実行自体は止まらずに先に進みます．
  * ラベルのスコープ (casl2)
  ラベルのスコープについては CASL II の仕様には特に記述がありません．本実装では，プログラム内(`START` から `END` まで)に独自の名前空間を与えることで，ラベルを局所変数のように扱えます．その一方で，大域変数に相当するものはありません．また，`CALL` 命令だけは，スコープ外の別プログラムのラベルを参照できます．

* サイレントモード (comet2)
  * comet2 の実行時に`-Q` オプションを付けることで，`OUT` 命令の出力以外を一切表示させないようにできます．

## 利用方法

`index.html` をブラウザで開いてください．

### CASL II アセンブラの基本的な使い方

casl2 アセンブラを使うには，casl2 のソースコードを左上のテキストボックスにペーストします．
その後，「Assemble」ボタンを押すと，アセンブルが実施されます．
文法エラーなどはこの時点で検出されます．例えば，

```
2: Illegal instruction "LEA"
2: Undefined symbol "TEST"
```
のように左下のボックスに何らかのメッセージが出て終了した場合は，表示されている行番号にエラーがあることを示しています．エディタで修正して再度アセンブルしてください．

### 詳細なアセンブル結果

詳細なアセンブル結果を知りたいときは `-a` オプションを付けて実行します．例えば，次のようなプログラムを `test.cas` とします．

```
TEST    START
        LAD     GR1,#000f
        LD      GR2,LAB1
        ADDA    GR1,GR2
        RET
LAB1    DC      245
END
```

これを -a オプションを付けてアセンブルした結果は次のようになります．

```
$ casl2 -a test.cas
CASL LISTING test.cas
2 0000 1210          LAD     GR1,#000f
2      000f
3 0002 1020          LD      GR2,LAB1
3      0006
4 0004 2412          ADDA    GR1,GR2
5 0005 8100          RET
6 0006 00f5  LAB1    DC      245

DEFINED SYMBOLS
test.cas:1:    0000    TEST
test.cas:6:    0006    LAB1
```

上側のリストは左から，「`test.cas` 中の行番号」「機械語の格納番地」「機械語命令」「ラベル」「対応する CASL II 命令」を表します．例えば，この例では `test.cas` の 2 行目に書かれた命令 `LAD GR1,#000f` は `1210 000f` という 2 語の機械語命令に変換され，`00000` 番地に格納されたことが分かります．

下側のリストはプログラム中で定義されたラベルの一覧です．どのラベルが何番地に対応するのかを表示しています．`test.cas` の 6 行目で定義されたラベル `LAB1` は `0006` 番地を示すことがわかります．

この詳細な結果を画面に表示するだけでなく，ファイルに保存したい場合は

```
$ casl2 -a test.cas > file
```

として下さい．`file` で指定したファイルに上の内容が書き込まれます．`-a` で出力される詳細情報は comet2 でブレークポイントを設定する際に必要となります．ややこしいデバッグをするときなどに威力を発揮しますので是非覚えて下さい．

###  COMET II シミュレータの使い方
#### 基本的な使い方

COMET II シミュレータを使うには，コマンドラインから次のように入力します．

```
$ comet2 filename.com
```

`filename.com` は casl2 でアセンブルした結果，生成されたファイルです．

実行すると次のように表示されます．ここでは `test.com` というファイルを実行した例を示します．

```
$ comet2 test.com
This is COMET II, version 2.0.
Copyright (c) 2001, Osamu Mizuno.
All rights reserved.
Reading object from test.com...done.

PR  #0000 [ LAD      GR1, #000f      ]
SP  #ff00(  -256)  FR  001  (     1)
GR0 #0000(     0)  GR1 #0000(     0)  GR2 #0000(     0)  GR3 #0000(     0)
GR4 #0000(     0)  GR5 #0000(     0)  GR6 #0000(     0)  GR7 #0000(     0)
comet>
```

画面に表示されているのは各レジスタの初期値です．1 行目には現在のプログラムレジスタの値 (`#0000`) とこれから実行すべき機械語命令 (`#0000` 番地の中身) が表示されています．そして，ユーザの入力を待つため，`comet>` というプロンプトが出て停止します．

##### ステップ実行 s(tep)

1 命令だけ実行させるには `step`（または `s`）という命令を使います．

##### 実行 r(un)

全命令を一気に実行させるには `run`（または `r`）という命令を使います．ただし，無限ループが存在するプログラムを `run` で実行させると固まったように見えます．この場合は，`Ctrl-C` を入力して comet2 の実行を強制終了させて下さい．

##### メモリダンプ du(mp)

計算機 COMET II の主記憶内を見るには `dump`（または `du`）という命令を使います．何に使うのか？`ST` 命令の実行が正しく行われているかを見るのが第 1 の目的だと思ってもらって結構です．

#### 高度な使い方

##### ブレークポイント設定 b(reak)

COMET II シミュレータには機械語プログラムの実行中，あらかじめ設定された番地まで実行が進むと一時的に実行を停止する機能があります．このとき，あらかじめ設定された番地のことをブレークポイントと呼びます．

ブレークポイントの設定には `break` (または `b`)という命令を使います．

この機能は特に長いプログラムをデバッグするときに有効です．1000 行もあるプログラムの終わりの 100 行に存在するであろうバグを発見するために `step` を何 100 回も繰り返してその場所まで到達するのはどう考えても非効率です．そこでデバッグしたい部分の入り口の番地をブレークポイントにすることで，そこまでの実行は `run` で行うことが出来ます．

この機能を有効に使うためには，casl2 アセンブラの `-a` オプションで生成される詳細なアセンブル結果が必須です．（慣れた人なら `dump` の結果だけでも適切なブレークポイントを判別できるかも知れません．）

### CASL II/COMET II リファレンス
#### CASL II アセンブラ: コマンドラインリファレンス
##### 詳細出力 (`-a`)

`-a` オプションはアセンブル結果の詳細を出力します．

#### COMET II シミュレータ: コマンドラインリファレンス
##### 出力抑制 (`-q`)

`-q` オプションは IN/OUT マクロでのプロンプト以外の出力を抑制します．

#### 出力抑制 (`-Q`)

`-Q` オプションは OUT マクロでの出力以外の出力を抑制します．これを指定すると通常のアプリケーションでの実行とほぼ同様の使い方になります．

#### COMET II シミュレータ: コマンドリファレンス
##### 実行 `r` (`run`)

Start execution of program.

プログラムの実行を開始します．設定されたブレークポイントが存在すると，実行を一旦停止し，コマンド待ち状態に戻ります．ブレークポイントが無い場合は，プログラムの最後まで実行を続けるため，必要に応じて `Ctrl-C` で comet2 シミュレータの動作自体を停止する必要があります．

##### ステップ実行 `s` (`step`)

Step execution. Argument N means do this N times.

ステップ実行を行います．引数を指定しないと，1 命令分だけ前に進みます．

```
comet> s 20
```

のように引数を指定すると，指定した数だけ命令を実行して停止します．

##### ブレークポイント設定 `b` (`break`)

Set a breakpoint at specified address.

ブレークポイントの設定を行います．引数は必須で，

```
comet> b #0010
```

のように指定します．引数はプログラムを停止すべきアドレスを表します．アドレスには 10 進，16 進の表記を使うことができますが，casl2 プログラムで指定したラベルを用いることはできません．任意の場所で実行を止めるためには，`casl2 -a` で出力される詳細なアセンブル結果を利用することが必要です．

##### ブレークポイント情報表示 `i` (`info`)

Print information on breakpoints.

##### ブレークポイント削除 `d` (`delete`)

Delete some breakpoints.

ブレークポイントを削除します．引数を指定しない場合はすべてのブレークポイントを削除するかの確認がされます．`info` コマンドで表示されるブレークポイント番号を引数をして指定することで，任意のブレークポイントを削除できます．

##### レジスタ表示 `p` (`print`)

Print status of `PC`/`FR`/`SP`/`GR0`..`GR7` registers.

レジスタの状態を表示します．`step` の後には必ず実行されます．

##### メモリダンプ `du` (`dump`)

Dump 128 words of memory image from specified address.

128 語分のメモリイメージを表示します．引数を与えない場合は現在の `PC` のアドレスから表示されます．引数を与えることで，任意のアドレスからのダンプを行います．

##### スタックダンプ `st` (`stack`)

Dump 128 words of stack image.

スタックの内容を 128 ワード分表示します．

##### ファイル読込 `f` (`file`)

Use FILE as program to be debugged.

引数は必須です．引数としてファイル名を指定し，そのファイルをオブジェクトコードとして読み込みます．オブジェクトコードの拡張子には`.com` が必要です．

##### ジャンプ `j` (`jump`)

Continue program at specifed address.

引数は必須です．`PC` を引数で指定したアドレスに強制的に指定し，その番地からプログラムを実行させます．

##### メモリ書き込み `m` (`memory`)

Change the memory at `ADDRESS` to `VALUE`.

引数は 2 つが必須です．

```
comet> m ADDRESS VALUE
```

`ADDRESS` に番地を，`VALUE` には値を指定し，`ADDRESS` で示した番地に `VALUE` を強制的に書き込みます．

##### 逆アセンブル `di` (`disasm`)

Disassemble 32 words from specified address.

引数で指定した番地から 32 ワード分を逆アセンブルします．引数を省略すると，現在の `PC` が示す番地からになります．

##### ヘルプ表示 `h` (`help`)

Print list of commands.

##### 終了 `q` (`quit`)

Exit comet2.
